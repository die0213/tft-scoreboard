<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFT 점수 내기 (실시간 리그)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #111827; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .player-card { transition: all 0.2s; cursor: grab; }
        .player-card:active { cursor: grabbing; }
        .drop-zone { transition: background-color 0.2s; border: 2px dashed transparent; }
        .drop-zone.drag-over { background-color: rgba(255, 255, 255, 0.1); border-color: #3b82f6; }
        .nav-button { transition: all 0.2s ease-in-out; }
        .nav-button.active { background-color: #3b82f6; color: white; }
        .nav-button:not(.active) { background-color: #374151; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // --- Supabase 설정 ---
        const supabaseUrl = 'https://ufuhfprvwgqsktomfrfn.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmdWhmcHJ2d2dxc2t0b21mcmZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODEzNTQsImV4cCI6MjA3MDc1NzM1NH0.pSQuwI0J4k7FBm3BXc88_9aPd2c8N_1fet3CgQ_CcG8';

        if (!window.supabase || supabaseUrl === 'YOUR_SUPABASE_URL') {
            const ErrorDisplay = () => (<div className="h-screen flex items-center justify-center text-center"><div className="bg-red-900 p-8 rounded-lg"><h2 className="text-2xl font-bold">Supabase 설정 필요</h2><p>코드를 수정하여 Supabase URL과 Key를 입력해주세요.</p></div></div>);
            ReactDOM.createRoot(document.getElementById('root')).render(<ErrorDisplay />);
        } else {
            const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            const Icon = ({ name, ...props }) => {
                if (!window.lucide || !window.lucide[name]) return <span style={{width: props.size || 16, height: props.size || 16}}></span>;
                const LucideIcon = window.lucide[name];
                return <LucideIcon {...props} />;
            };

            const initialSettings = {
                targetScore: 100,
                rankScores: { 1: 10, 2: 8, 3: 7, 4: 6, 5: 4, 6: 3, 7: 2, 8: 1 },
                event: { name: "이벤트 없음", description: "", type: "없음", value: 0, active: false }
            };

            function App() {
                const [players, setPlayers] = useState([]);
                const [activeLeague, setActiveLeague] = useState(null);
                const [games, setGames] = useState([]);
                const [appState, setAppState] = useState('loading');

                useEffect(() => {
                    const fetchInitialData = async () => {
                        const { data: playersData } = await supabase.from('players').select('*');
                        setPlayers(playersData || []);

                        const { data: leagueData } = await supabase.from('leagues').select('*').eq('is_active', true).single();
                        
                        if (leagueData) {
                            setActiveLeague(leagueData);
                            const { data: gamesData } = await supabase.from('games').select('*').eq('league_id', leagueData.id).order('created_at', { ascending: false });
                            setGames(gamesData || []);
                            setAppState(leagueData.winner ? 'victory' : 'league');
                        } else {
                            setActiveLeague(null);
                            setGames([]);
                            setAppState('lobby');
                        }
                    };

                    fetchInitialData();
                    
                    const handlePlayerChanges = (payload) => {
                        if (payload.eventType === 'INSERT') setPlayers(current => [...current, payload.new]);
                        if (payload.eventType === 'UPDATE') setPlayers(current => current.map(p => p.id === payload.new.id ? payload.new : p));
                        if (payload.eventType === 'DELETE') setPlayers(current => current.filter(p => p.id !== payload.old.id));
                    };
                    const handleLeagueChanges = (payload) => {
                        if (payload.eventType === 'INSERT' && payload.new.is_active) {
                            fetchInitialData(); // 새 리그 시작 시 전체 데이터 리프레시
                        }
                        if (payload.eventType === 'UPDATE') {
                            // 현재 리그가 비활성화 되면 로비로 전환
                            if (activeLeague && payload.new.id === activeLeague.id && !payload.new.is_active) {
                                fetchInitialData();
                            } else {
                                setActiveLeague(payload.new);
                                if (payload.new.winner) setAppState('victory');
                            }
                        }
                    };
                    const handleGameChanges = (payload) => {
                        if (activeLeague && payload.new.league_id === activeLeague.id) {
                            if (payload.eventType === 'INSERT') setGames(current => [payload.new, ...current].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)));
                            if (payload.eventType === 'UPDATE') setGames(current => current.map(g => g.id === payload.new.id ? payload.new : g));
                            if (payload.eventType === 'DELETE') setGames(current => current.filter(g => g.id !== payload.old.id));
                        }
                    };

                    const subscriptions = [
                        supabase.channel('public:players').on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, handlePlayerChanges).subscribe(),
                        supabase.channel('public:leagues').on('postgres_changes', { event: '*', schema: 'public', table: 'leagues' }, handleLeagueChanges).subscribe(),
                        supabase.channel('public:games').on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, handleGameChanges).subscribe()
                    ];
                    
                    return () => subscriptions.forEach(sub => supabase.removeChannel(sub));
                }, [activeLeague]);
                
                if (appState === 'loading') return <div className="flex justify-center items-center h-screen"><p>데이터 로딩 중...</p></div>;
                if (appState === 'lobby') return <Lobby players={players} />;
                if (appState === 'league' && activeLeague) return <LeagueView league={activeLeague} players={players} games={games} />;
                if (appState === 'victory' && activeLeague) return <VictoryView league={activeLeague} players={players} games={games} setAppState={setAppState} />;
                
                return <div>오류가 발생했습니다. 새로고침 해주세요.</div>;
            }

            const Lobby = ({ players }) => {
                const [newPlayerName, setNewPlayerName] = useState('');
                const [teams, setTeams] = useState({ red: [], blue: [] });
                const [targetScore, setTargetScore] = useState(100);
                const [isStarting, setIsStarting] = useState(false);

                const handleAddPlayer = async (e) => {
                    e.preventDefault();
                    if (!newPlayerName) return;
                    await supabase.from('players').insert({ name: newPlayerName });
                    setNewPlayerName('');
                };

                const handleDrop = (e, targetTeam) => {
                    e.preventDefault();
                    const playerId = e.dataTransfer.getData("playerId");
                    const player = players.find(p => p.id == playerId);
                    if (player) {
                        setTeams(prev => {
                            const newTeams = {
                                red: prev.red.filter(p => p.id != playerId),
                                blue: prev.blue.filter(p => p.id != playerId)
                            };
                            if (targetTeam) {
                                newTeams[targetTeam].push(player);
                            }
                            return newTeams;
                        });
                    }
                    e.currentTarget.classList.remove('drag-over');
                };

                const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
                const handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); };

                const unassignedPlayers = useMemo(() => {
                    const assignedIds = new Set([...teams.red.map(p => p.id), ...teams.blue.map(p => p.id)]);
                    return players.filter(p => !assignedIds.has(p.id));
                }, [players, teams]);

                const handleRandomize = () => {
                    const shuffled = [...players].sort(() => 0.5 - Math.random());
                    const mid = Math.ceil(shuffled.length / 2);
                    setTeams({ red: shuffled.slice(0, mid), blue: shuffled.slice(mid) });
                };

                const handleBalance = () => {
                    const sorted = [...players].sort((a,b) => (b.total_score_contributed || 0) - (a.total_score_contributed || 0));
                    const balanced = {red:[], blue:[]};
                    const scores = {red:0, blue:0};
                    sorted.forEach(p => {
                        if(scores.red <= scores.blue){
                            balanced.red.push(p);
                            scores.red += (p.total_score_contributed || 0);
                        } else {
                            balanced.blue.push(p);
                            scores.blue += (p.total_score_contributed || 0);
                        }
                    });
                    setTeams(balanced);
                };

                const handleStartLeague = async () => {
                    const teamPlayerIds = { red: teams.red.map(p => p.id), blue: teams.blue.map(p => p.id) };
                    if (teamPlayerIds.red.length === 0 || teamPlayerIds.blue.length === 0) {
                        alert("양 팀에 최소 한 명의 선수가 있어야 합니다.");
                        return;
                    }
                    
                    setIsStarting(true);
                    try {
                        await supabase.from('leagues').update({ is_active: false }).eq('is_active', true);
                        const { error } = await supabase.from('leagues').insert({
                            target_score: targetScore,
                            settings: initialSettings,
                            teams: teamPlayerIds
                        });
                        if (error) throw error;
                    } catch (error) {
                        console.error("리그 시작 오류:", error);
                        alert(`리그 시작에 실패했습니다: ${error.message}`);
                    } finally {
                        setIsStarting(false);
                    }
                };

                return (
                    <div className="container mx-auto p-4 md:p-8">
                        <h1 className="text-4xl font-bold text-center mb-8">새 리그 시작하기</h1>
                        <div className="grid md:grid-cols-3 gap-8">
                            <div className="md:col-span-1 bg-gray-800 p-4 rounded-lg">
                                <h2 className="text-xl font-bold mb-4">선수 관리</h2>
                                <form onSubmit={handleAddPlayer} className="flex gap-2 mb-4">
                                    <input value={newPlayerName} onChange={e => setNewPlayerName(e.target.value)} placeholder="새 선수 이름" className="flex-grow bg-gray-700 rounded px-3 py-2" />
                                    <button type="submit" className="bg-green-600 hover:bg-green-700 text-white p-2 rounded"><Icon name="Plus" /></button>
                                </form>
                                <div className="drop-zone p-2 rounded-lg" onDrop={(e) => handleDrop(e, null)} onDragOver={handleDragOver} onDragLeave={handleDragLeave}>
                                    <h3 className="font-semibold mb-2">미배정 선수</h3>
                                    <div className="space-y-2 max-h-60 overflow-y-auto p-1 min-h-[100px]">
                                        {unassignedPlayers.map(p => <PlayerCard key={p.id} player={p} />)}
                                    </div>
                                </div>
                            </div>
                            <div className="md:col-span-2 bg-gray-800 p-4 rounded-lg">
                                <h2 className="text-xl font-bold mb-4">팀 구성</h2>
                                <div className="flex justify-center gap-2 my-4">
                                    <button onClick={handleRandomize} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">전체 랜덤</button>
                                    <button onClick={handleBalance} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">밸런스</button>
                                    <button onClick={() => setTeams({red: [], blue: []})} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">초기화</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <TeamDropZone team="red" title="레드 팀" players={teams.red} onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave} />
                                    <TeamDropZone team="blue" title="블루 팀" players={teams.blue} onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave} />
                                </div>
                                <div className="mt-6 flex items-center gap-4">
                                    <label className="font-semibold">목표 점수:</label>
                                    <input type="number" value={targetScore} onChange={e => setTargetScore(Number(e.target.value))} className="bg-gray-700 rounded px-3 py-2 w-24" />
                                    <button onClick={handleStartLeague} disabled={isStarting} className="ml-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg disabled:bg-gray-500 disabled:cursor-not-allowed">
                                        {isStarting ? '시작 중...' : '리그 시작'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const PlayerCard = ({ player }) => ( <div draggable="true" onDragStart={(e) => e.dataTransfer.setData("playerId", player.id)} className="player-card bg-gray-700 p-2 rounded text-center">{player.name}</div> );
            const TeamDropZone = ({ team, title, players, onDrop, onDragOver, onDragLeave }) => ( <div onDrop={(e) => onDrop(e, team)} onDragOver={onDragOver} onDragLeave={onDragLeave} className={`drop-zone p-3 rounded-lg ${team === 'red' ? 'bg-red-900/50' : 'bg-blue-900/50'}`}><h3 className={`text-lg font-bold text-center ${team === 'red' ? 'text-red-300' : 'text-blue-300'}`}>{title}</h3><div className="mt-2 space-y-2 min-h-[150px]">{players.map(p => <PlayerCard key={p.id} player={p} />)}</div></div> );
            
            const LeagueView = ({ league, players, games }) => {
                const [activeTab, setActiveTab] = useState('board');
                const getTeamPlayers = (teamColor) => league.teams[teamColor].map(id => players.find(p => p.id === id)).filter(Boolean);

                return (
                    <div className="container mx-auto p-4 md:p-8">
                        <div className="flex border-b border-gray-700 mb-6">
                            <button className={`nav-button flex-1 py-3 px-4 font-bold rounded-t-lg ${activeTab === 'board' ? 'active' : ''}`} onClick={() => setActiveTab('board')}>대전 보드</button>
                            <button className={`nav-button flex-1 py-3 px-4 font-bold rounded-t-lg ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>리그 관리</button>
                        </div>

                        {activeTab === 'board' && (
                            <div>
                                <h1 className="text-4xl font-bold text-center mb-2">리그 진행 중</h1>
                                <p className="text-center text-gray-400 mb-8">목표 점수: {league.target_score}점</p>
                                <div className="grid grid-cols-2 gap-4 md:gap-8 mb-8">
                                    <TeamScoreCard teamColor="red" teamName="레드 팀" players={getTeamPlayers('red')} score={league.scores.red} />
                                    <TeamScoreCard teamColor="blue" teamName="블루 팀" players={getTeamPlayers('blue')} score={league.scores.blue} />
                                </div>
                                <GameBoard league={league} players={players} games={games} />
                            </div>
                        )}
                        {activeTab === 'settings' && <LeagueSettings league={league} />}
                    </div>
                );
            };

            const GameBoard = ({ league, players, games }) => {
                const ongoingGames = useMemo(() => games.filter(g => g.status === 'ongoing'), [games]);
                const finishedGames = useMemo(() => games.filter(g => g.status === 'finished'), [games]);
                const teamSize = league.teams.red.length;

                return (
                    <div>
                        <div className="bg-gray-800 p-4 rounded-lg">
                            <h2 className="text-2xl font-bold text-center mb-4">현재 대전중인 그룹</h2>
                            <div className="space-y-4">
                                {Array.from({ length: teamSize }).map((_, index) => {
                                    const gameForGroup = ongoingGames[index];
                                    return (
                                        <div key={index} className="bg-gray-900/50 p-4 rounded-lg">
                                            <h3 className="font-bold text-lg mb-2">그룹 {index + 1}</h3>
                                            {gameForGroup ? 
                                                <OngoingGame game={gameForGroup} league={league} players={players} /> : 
                                                <Matchmaker league={league} players={players} ongoingGames={ongoingGames} />
                                            }
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <GameHistory games={finishedGames} players={players} />
                    </div>
                );
            };

            const Matchmaker = ({ league, players, ongoingGames }) => {
                const [redPlayer, setRedPlayer] = useState('');
                const [bluePlayer, setBluePlayer] = useState('');

                const busyPlayerIds = useMemo(() => new Set(ongoingGames.flatMap(g => g.participants)), [ongoingGames]);

                const availableRedPlayers = useMemo(() => 
                    league.teams.red
                        .map(id => players.find(p => p.id === id))
                        .filter(p => p && !busyPlayerIds.has(p.id) && p.id != bluePlayer), 
                [league, players, busyPlayerIds, bluePlayer]);

                const availableBluePlayers = useMemo(() => 
                    league.teams.blue
                        .map(id => players.find(p => p.id === id))
                        .filter(p => p && !busyPlayerIds.has(p.id) && p.id != redPlayer), 
                [league, players, busyPlayerIds, redPlayer]);

                const handleStartGame = async () => {
                    if (!redPlayer || !bluePlayer) { alert("양 팀에서 선수를 한 명씩 선택해야 합니다."); return; }
                    const participants = [Number(redPlayer), Number(bluePlayer)];
                    await supabase.from('games').insert({ league_id: league.id, participants });
                };

                return (
                    <div>
                        <div className="grid grid-cols-2 gap-4 items-end">
                            <div>
                                <label className="block mb-1 font-semibold text-red-400 text-sm">레드 팀 선수</label>
                                <select value={redPlayer} onChange={e => setRedPlayer(e.target.value)} className="w-full bg-gray-700 p-2 rounded text-sm">
                                    <option value="">선택...</option>
                                    {availableRedPlayers.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                            </div>
                             <div>
                                <label className="block mb-1 font-semibold text-blue-400 text-sm">블루 팀 선수</label>
                                <select value={bluePlayer} onChange={e => setBluePlayer(e.target.value)} className="w-full bg-gray-700 p-2 rounded text-sm">
                                    <option value="">선택...</option>
                                    {availableBluePlayers.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                            </div>
                        </div>
                         <div className="text-center mt-4">
                            <button onClick={handleStartGame} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">게임 시작</button>
                        </div>
                    </div>
                );
            };

            const OngoingGame = ({ game, league, players }) => {
                const [isFinalizing, setIsFinalizing] = useState(false);
                const [finalizedData, setFinalizedData] = useState(null);

                const participants = useMemo(() => game.participants.map(id => players.find(p => p.id === id)).filter(Boolean), [game, players]);
                const usedRanks = useMemo(() => new Set(Object.values(game.ranks || {})), [game.ranks]);
                const allRanksAssigned = participants.length > 0 && participants.length === Object.keys(game.ranks || {}).length && Object.values(game.ranks || {}).every(Boolean);

                const handleRankChange = async (playerId, rank) => {
                    const newRanks = { ...(game.ranks || {}) };
                    if (rank) { newRanks[playerId] = Number(rank); } else { delete newRanks[playerId]; }
                    await supabase.from('games').update({ ranks: newRanks }).eq('id', game.id);
                };

                const handleCancelGame = async () => {
                    if (window.confirm("이 게임을 취소하시겠습니까?")) {
                        await supabase.from('games').delete().eq('id', game.id);
                    }
                };

                const handleFinalizeGame = async () => {
                    setIsFinalizing(true);
                    let scoreChanges = {};
                    let teamScoreChanges = { red: 0, blue: 0 };
                    const playerUpdates = [];
                    participants.forEach(player => {
                        const rank = game.ranks[player.id];
                        const teamColor = league.teams.red.includes(player.id) ? 'red' : 'blue';
                        
                        let scoreChange = league.settings.rankScores[rank] || 0;
                        if (league.settings.event.active) {
                            const event = league.settings.event;
                            if (event.type === '배율') scoreChange *= event.value;
                            else if (event.type === '추가') scoreChange += event.value;
                            else if (event.type === '감소') scoreChange -= event.value;
                        }

                        scoreChanges[player.id] = { rank, scoreChange };
                        teamScoreChanges[teamColor] += scoreChange;
                        playerUpdates.push({ id: player.id, games_played: (player.games_played || 0) + 1, total_score_contributed: (player.total_score_contributed || 0) + scoreChange });
                    });
                    
                    setFinalizedData(scoreChanges);

                    const newScores = { red: league.scores.red + teamScoreChanges.red, blue: league.scores.blue + teamScoreChanges.blue };
                    let winner = null;
                    if (newScores.red >= league.target_score) winner = 'red';
                    if (newScores.blue >= league.target_score) winner = 'blue';
                    
                    await supabase.from('games').update({ status: 'finished', score_changes: scoreChanges }).eq('id', game.id);
                    await supabase.from('leagues').update({ scores: newScores, winner: winner, is_active: winner ? false : true }).eq('id', league.id);
                    await supabase.from('players').upsert(playerUpdates);
                };

                if (finalizedData) {
                    return (
                        <div>
                            <p className="text-center text-green-400 mb-2">결과가 등록되었습니다!</p>
                            <ul className="space-y-1">
                                {Object.entries(finalizedData).sort(([,a],[,b]) => a.rank - b.rank).map(([playerId, data]) => {
                                    const player = players.find(p => p.id == playerId);
                                    return (<li key={playerId} className="flex justify-between text-sm bg-gray-700 p-2 rounded"><span>{data.rank}등: {player?.name}</span><span className={data.scoreChange >= 0 ? 'text-green-400' : 'text-red-400'}>{data.scoreChange >= 0 ? '+' : ''}{data.scoreChange}점</span></li>);
                                })}
                            </ul>
                        </div>
                    );
                }

                return (
                    <div>
                        <div className="space-y-2">
                            {participants.map(p => (
                                <div key={p.id} className="flex justify-between items-center bg-gray-700 p-2 rounded">
                                    <p className="font-semibold">{p.name}</p>
                                    <select 
                                        value={game.ranks?.[p.id] || ''}
                                        onChange={e => handleRankChange(p.id, e.target.value)} 
                                        className="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm"
                                    >
                                        <option value="">등수</option>
                                        {[...Array(8).keys()].map(i => {
                                            const rankValue = i + 1;
                                            const isUsedByOther = usedRanks.has(rankValue) && game.ranks?.[p.id] !== rankValue;
                                            return (<option key={rankValue} value={rankValue} disabled={isUsedByOther}>{rankValue}등 {isUsedByOther ? '(선택됨)' : ''}</option>);
                                        })}
                                    </select>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-between items-center mt-4">
                            <button onClick={handleCancelGame} className="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-xs">경기 취소</button>
                            <button onClick={handleFinalizeGame} disabled={!allRanksAssigned || isFinalizing} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-gray-500 disabled:cursor-not-allowed">
                                {isFinalizing ? "등록 중..." : "결과 등록"}
                            </button>
                        </div>
                    </div>
                );
            };

            const TeamScoreCard = ({ teamColor, teamName, players, score }) => ( <div className={`p-4 rounded-lg ${teamColor === 'red' ? 'bg-red-900/50' : 'bg-blue-900/50'}`}><h2 className={`text-2xl font-bold text-center mb-4 ${teamColor === 'red' ? 'text-red-300' : 'text-blue-300'}`}>{teamName}</h2><p className="text-5xl font-bold text-center text-white mb-4">{score}점</p><div className="space-y-2">{players.map(p => (<div key={p.id} className="bg-gray-800 p-2 rounded text-center">{p.name}</div>))}</div></div> );
            const GameHistory = ({ games, players }) => ( <div className="bg-gray-800 p-4 rounded-lg mt-8"><h2 className="text-xl font-bold mb-4">경기 기록</h2><div className="space-y-4 max-h-96 overflow-y-auto">{games.map(game => (<div key={game.id} className="bg-gray-700 p-3 rounded"><p className="text-xs text-gray-400 mb-2">{new Date(game.created_at).toLocaleString()}</p><ul className="space-y-1">{Object.entries(game.score_changes || {}).sort(([,a],[,b]) => a.rank - b.rank).map(([playerId, data]) => { const player = players.find(p => p.id == playerId); return (<li key={playerId} className="flex justify-between text-sm"><span>{data.rank}등: {player?.name || '?'}</span><span className={data.scoreChange >= 0 ? 'text-green-400' : 'text-red-400'}>{data.scoreChange >= 0 ? '+' : ''}{data.scoreChange}점</span></li>); })}</ul></div>))}</div></div> );
            const VictoryView = ({ league, players, games, setAppState }) => {
                const gameStats = useMemo(() => {
                    const playerStats = {};
                    [...league.teams.red, ...league.teams.blue].forEach(id => playerStats[id] = { score: 0, games: 0 });
                    games.forEach(game => { if(game.score_changes) Object.entries(game.score_changes).forEach(([playerId, data]) => { if (playerStats[playerId]) { playerStats[playerId].score += data.scoreChange; playerStats[playerId].games += 1; } }); });
                    const allPlayers = Object.entries(playerStats).map(([id, data]) => ({ id: Number(id), name: players.find(p => p.id == id)?.name, ...data }));
                    return { mvp: [...allPlayers].sort((a, b) => b.score - a.score)[0], lvp: [...allPlayers].sort((a, b) => a.score - b.score)[0], mostGames: [...allPlayers].sort((a, b) => b.games - a.games)[0] };
                }, [league, games, players]);

                const handleNewLeague = async () => { 
                    await supabase.from('leagues').update({ is_active: false }).eq('id', league.id);
                    setAppState('lobby'); // [FIX] Immediately transition to lobby
                };

                return (
                    <div className="container mx-auto p-4 md:p-8 text-center">
                        <h1 className="text-5xl font-bold text-yellow-400 mb-4">🎉 {league.winner === 'red' ? '레드 팀' : '블루 팀'} 승리! 🎉</h1>
                        <p className="text-2xl mb-8">{league.scores.red} vs {league.scores.blue}</p>
                        <div className="grid md:grid-cols-3 gap-6 text-left max-w-4xl mx-auto">
                            <div className="bg-green-800/50 p-4 rounded-lg"><h3 className="text-lg font-bold text-green-300">MVP (최고 득점)</h3><p className="text-2xl font-bold">{gameStats.mvp?.name}</p><p className="text-lg text-green-400">+{gameStats.mvp?.score}점</p></div>
                            <div className="bg-red-800/50 p-4 rounded-lg"><h3 className="text-lg font-bold text-red-300">LVP (최저 득점)</h3><p className="text-2xl font-bold">{gameStats.lvp?.name}</p><p className="text-lg text-red-400">{gameStats.lvp?.score}점</p></div>
                            <div className="bg-blue-800/50 p-4 rounded-lg"><h3 className="text-lg font-bold text-blue-300">최다 출전</h3><p className="text-2xl font-bold">{gameStats.mostGames?.name}</p><p className="text-lg text-blue-400">{gameStats.mostGames?.games}회</p></div>
                        </div>
                        <button onClick={handleNewLeague} className="mt-12 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl">
                            새 리그 시작하기
                        </button>
                    </div>
                );
            };
            
            const LeagueSettings = ({ league }) => {
                const [targetScore, setTargetScore] = useState(league.target_score);
                const [settings, setSettings] = useState(league.settings);
                const [isSaving, setIsSaving] = useState(false);

                const handleRankScoreChange = (rank, value) => {
                    setSettings(prev => ({ ...prev, rankScores: { ...prev.rankScores, [rank]: Number(value) } }));
                };
                const handleEventChange = (key, value) => {
                    setSettings(prev => ({ ...prev, event: { ...prev.event, [key]: value } }));
                };

                const handleSave = async () => {
                    setIsSaving(true);
                    const { error } = await supabase.from('leagues').update({ target_score: targetScore, settings: settings }).eq('id', league.id);
                    if (error) {
                        alert(`저장 실패: ${error.message}`);
                    } else {
                        alert('설정이 저장되었습니다.');
                    }
                    setIsSaving(false);
                };

                return (
                    <div className="bg-gray-800 p-4 rounded-lg max-w-3xl mx-auto">
                        <h2 className="text-2xl font-bold text-center mb-6">리그 관리</h2>
                        <div className="space-y-6">
                            <div>
                                <label className="block font-semibold mb-2 text-lg">목표 점수</label>
                                <input type="number" value={targetScore} onChange={e => setTargetScore(Number(e.target.value))} className="w-full bg-gray-700 rounded px-3 py-2" />
                            </div>
                            <div>
                                <h3 className="font-semibold mb-2 text-lg">등수별 점수</h3>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    {Object.entries(settings.rankScores).map(([rank, score]) => (
                                        <div key={rank}>
                                            <label className="text-sm">{rank}등</label>
                                            <input type="number" value={score} onChange={e => handleRankScoreChange(rank, e.target.value)} className="w-full bg-gray-700 rounded px-2 py-1" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                             <div>
                                <h3 className="font-semibold mb-2 text-lg">이벤트 설정</h3>
                                <div className="bg-gray-900/50 p-4 rounded-lg space-y-3">
                                    <input type="text" value={settings.event.name} onChange={e => handleEventChange('name', e.target.value)} placeholder="이벤트 이름" className="w-full bg-gray-700 rounded px-3 py-2" />
                                    <textarea value={settings.event.description} onChange={e => handleEventChange('description', e.target.value)} placeholder="이벤트 내용" className="w-full bg-gray-700 rounded px-3 py-2" rows="2"></textarea>
                                    <div className="flex gap-4">
                                        <select value={settings.event.type} onChange={e => handleEventChange('type', e.target.value)} className="flex-grow bg-gray-700 rounded px-3 py-2">
                                            <option value="없음">없음</option>
                                            <option value="배율">점수 배율</option>
                                            <option value="추가">추가 점수</option>
                                            <option value="감소">점수 감소</option>
                                        </select>
                                        <input type="number" step="0.1" value={settings.event.value} onChange={e => handleEventChange('value', Number(e.target.value))} placeholder="값" className="w-24 bg-gray-700 rounded px-3 py-2" />
                                    </div>
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" checked={settings.event.active} onChange={e => handleEventChange('active', e.target.checked)} className="h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500" />
                                        <span>이벤트 활성화</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div className="text-center mt-8">
                            <button onClick={handleSave} disabled={isSaving} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg disabled:bg-gray-500">
                                {isSaving ? '저장 중...' : '설정 저장'}
                            </button>
                        </div>
                    </div>
                );
            };

            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        }
    </script>
</body>
</html>
